<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Monaco Editor CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>
    <style>
        .editor-container { 
            height: calc(50vh - 2rem);  /* Adjusted for mobile */
            min-height: 300px;
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .diff-container {
            height: calc(50vh - 2rem);  /* Adjusted for mobile */
            min-height: 300px;
            border: none;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        #preview-container {
            height: calc(100vh - 4rem);  /* Adjusted for mobile */
            min-height: 400px;
        }
        /* Add smooth transitions */
        .transition-all {
            transition: all 0.2s ease-in-out;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e1e1e;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #3e3e3e;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            .p-6 {
                padding: 1rem;
            }
            .gap-8 {
                gap: 1rem;
            }
            .max-w-7xl {
                padding: 0.5rem;
            }
            /* Stack buttons vertically on mobile */
            #diffControls, .button-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            .button-group button {
                width: 100%;
            }
        }
        /* Modern glass morphism effects for dark mode */
        .dark-glass-effect {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(50, 50, 50, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen">
    <div class="max-w-7xl mx-auto p-6 space-y-8">
        <h1 class="text-3xl md:text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-violet-500 tracking-tight">Code Editor</h1>
        <div class="grid grid-cols-2 gap-8">
            <!-- Left Column: Editor Section -->
            <div class="space-y-8">
                <div class="space-y-6 dark-glass-effect p-6 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-100">Editor</h2>
                    <input type="text" id="filename" placeholder="Filename (optional)" 
                        class="w-full p-3 border border-gray-700 rounded-md bg-gray-800 text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500/40 focus:border-blue-500 transition-all">
                    <div id="editorContainer" class="editor-container">
                        <div id="editor" class="h-full"></div>
                        <div id="diffEditor" class="h-full hidden"></div>
                    </div>
                    <!-- Diff Controls - Hidden by default -->
                    <div id="diffControls" class="flex space-x-4 hidden">
                        <button onclick="applyChanges()" 
                            class="px-6 py-2.5 bg-green-600 text-gray-100 rounded-md hover:bg-green-700 transition-all shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-green-500/40">
                            Apply Changes
                        </button>
                        <button onclick="rejectChanges()" 
                            class="px-6 py-2.5 bg-red-600 text-gray-100 rounded-md hover:bg-red-700 transition-all shadow-sm hover:shadow focus:outline-none focus:ring-2 focus:ring-red-500/40">
                            Reject Changes
                        </button>
                    </div>
                    <textarea id="editRequest" placeholder="Describe the changes you want to make..."
                        class="w-full h-32 p-4 border border-gray-700 bg-gray-800 text-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500/40 focus:border-blue-500 transition-all resize-none"></textarea>

                    <!-- Add image context upload -->
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center space-x-2 text-sm text-gray-400 font-medium cursor-pointer hover:text-blue-400 transition-colors">
                            <input type="checkbox" id="useImageContext" class="rounded text-blue-500 bg-gray-700 border-gray-600 focus:ring-blue-500/40">
                            <span>Include image as context</span>
                        </label>
                        <div id="imageUploadContainer" class="hidden">
                            <input type="file" id="imageUpload" accept="image/*" class="hidden" />
                            <div class="flex items-center space-x-3">
                                <button onclick="document.getElementById('imageUpload').click()" 
                                    class="px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600 transition-all flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    Select Image
                                </button>
                                <span id="selectedImageName" class="text-sm text-gray-400">No image selected</span>
                                <span class="text-xs text-blue-400 ml-2">(or paste image from clipboard)</span>
                            </div>
                            <div id="imagePreview" class="mt-2 hidden">
                                <img id="previewImg" class="max-h-32 rounded-lg shadow-sm" />
                                <button onclick="removeImage()" class="mt-1 text-xs text-red-400 hover:text-red-300">Remove</button>
                            </div>
                        </div>
                    </div>

                    <div class="button-group flex flex-wrap gap-2">
                        <button onclick="submitEditRealtime()" 
                            class="flex-1 px-6 py-2.5 bg-gradient-to-r from-blue-600 to-violet-600 text-gray-100 rounded-md hover:from-blue-700 hover:to-violet-700 transition-all shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500/40">
                            Submit Edit Request
                        </button>
                        <button onclick="saveContentToKey()" 
                            class="flex-1 px-6 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-600 text-gray-100 rounded-md hover:from-emerald-700 hover:to-teal-700 transition-all shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-emerald-500/40">
                            Save Changes
                        </button>
                    </div>
                </div>
                
                <!-- Output Section -->
                <div id="assistantOutput" class="p-6 bg-gray-800 rounded-lg shadow-sm"></div>
            </div>

            <!-- Right Column: Preview Section -->
            <div class="dark-glass-effect p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-6 text-gray-100">Preview</h2>
                <div class="rounded-lg overflow-hidden shadow-sm h-[calc(100vh-12rem)] md:h-[calc(100vh-8rem)]">
                    <!-- Preview Header -->
                    <div class="border-b border-gray-700 p-3 flex items-center space-x-2 bg-gray-800">
                        <div class="flex space-x-2">
                            <div class="w-3 h-3 rounded-full bg-red-500 shadow-sm"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500 shadow-sm"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500 shadow-sm"></div>
                        </div>
                        <div class="text-sm text-gray-400 flex-1 text-center font-medium">Preview</div>
                    </div>
                    <div id="preview-container">
                        <iframe id="previewFrame" class="w-full h-full border-0 bg-white"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editor, diffEditor;
        let originalModel, modifiedModel;
        let currentKey = null;

        // Add function to get URL parameters
        function getUrlParameter(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Add function to load content from key
        async function loadContentFromKey(key) {
            try {
                const response = await fetch(`https://jordanjohngilbert.link/read?key=${key}`);
                if (!response.ok) throw new Error('Failed to load content');
                const data = await response.json();
                
                if (data.value) {
                    // Check if the value has an html property (app format)
                    const content = data.value.html || data.value;
                    editor.setValue(typeof content === 'string' ? content : JSON.stringify(content, null, 2));
                    currentKey = key;
                    updatePreview();
                }
            } catch (error) {
                console.error('Error loading content:', error);
                document.getElementById('assistantOutput').innerHTML = `
                    <div class="p-4 bg-red-900/30 text-red-300 rounded">
                        Error loading content: ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        // Add function to save content to key
        async function saveContentToKey() {
            if (!currentKey) return;
            
            try {
                const content = editor.getValue();
                const response = await fetch('https://jordanjohngilbert.link/write', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: currentKey,
                        value: {
                            html: content,
                            created_at: new Date().toISOString(),
                            prompt: "Updated via editor"
                        }
                    }),
                });
                
                if (!response.ok) throw new Error('Failed to save content');
                
                document.getElementById('assistantOutput').innerHTML = `
                    <div class="p-4 bg-green-900/30 text-green-300 rounded">
                        Content saved successfully!
                    </div>
                `;
            } catch (error) {
                console.error('Error saving content:', error);
                document.getElementById('assistantOutput').innerHTML = `
                    <div class="p-4 bg-red-900/30 text-red-300 rounded">
                        Error saving content: ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        // Initialize Monaco Editor
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            // Initialize the main editor with dark theme
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: '',
                language: 'html',
                theme: 'vs-dark',
                minimap: { enabled: false },
                automaticLayout: true,
                // Add undo/redo configuration
                autoIndent: 'full',
                contextmenu: true,
                // Enable all default keyboard shortcuts including Ctrl+Z/Cmd+Z for undo
                // and Ctrl+Shift+Z/Cmd+Shift+Z for redo
                ariaLabel: 'Editor with undo/redo support'
            });

            // Initialize the diff editor with inline diff
            diffEditor = monaco.editor.createDiffEditor(document.getElementById('diffEditor'), {
                enableSplitViewResizing: false,
                renderSideBySide: false,
                automaticLayout: true,
                originalEditable: false,
                readOnly: false,
                theme: 'vs-dark'
            });

            // Create initial models
            originalModel = monaco.editor.createModel('', 'html');
            modifiedModel = monaco.editor.createModel('', 'html');
            diffEditor.setModel({
                original: originalModel,
                modified: modifiedModel
            });

            // Check for key parameter and load content
            const key = getUrlParameter('key');
            if (key) {
                loadContentFromKey(key);
            }
        });

        async function submitEditRealtime() {
            const editRequest = document.getElementById('editRequest').value;
            const filename = document.getElementById('filename').value;
            const fileContent = editor.getValue();
            const assistantOutput = document.getElementById('assistantOutput');
            const useImageContext = document.getElementById('useImageContext').checked;
            
            // Show processing state with animated loading dots
            assistantOutput.innerHTML = '<div id="loading-message" class="p-4 bg-blue-50 text-blue-700 rounded"><p class="font-medium">Working on your website<span id="loading-dots">...</span></p><p class="text-sm mt-1">This may take a few moments.</p></div>';
            
            // Start the loading animation
            startLoadingAnimation();
            
            try {
                // Create request body
                const body = {
                    file_content: fileContent,
                    edit_request: editRequest,
                    filename: filename
                };
                
                // Add image data if selected
                if (useImageContext) {
                    const imageInput = document.getElementById('imageUpload');
                    // First check for pasted image
                    if (window.pastedImageFile) {
                        const reader = new FileReader();
                        const imagePromise = new Promise((resolve, reject) => {
                            reader.onload = e => resolve(e.target.result);
                            reader.onerror = e => reject(e);
                            reader.readAsDataURL(window.pastedImageFile);
                        });
                        
                        const imageData = await imagePromise;
                        // Remove the data:image/xxx;base64, prefix
                        body.image_data = imageData.split(',')[1];
                        body.image_type = window.pastedImageFile.type;
                    }
                    // Then check for uploaded file
                    else if (imageInput.files && imageInput.files[0]) {
                        const reader = new FileReader();
                        const imagePromise = new Promise((resolve, reject) => {
                            reader.onload = e => resolve(e.target.result);
                            reader.onerror = e => reject(e);
                            reader.readAsDataURL(imageInput.files[0]);
                        });
                        
                        const imageData = await imagePromise;
                        // Remove the data:image/xxx;base64, prefix
                        body.image_data = imageData.split(',')[1];
                        body.image_type = imageInput.files[0].type;
                    }
                }
                
                // Store original content for undo capability and diffing
                const originalContent = fileContent;
                
                // Use fetch to create a server-sent events stream
                const response = await fetch('/api/edit/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let outputContent = '';
                let tokenInfo = '';
                
                // Create assistant output div structure with stream output display
                assistantOutput.innerHTML = `
                    <div class="mb-4 p-4 bg-blue-50 text-blue-700 rounded">
                        <p class="font-medium">Building your website<span id="loading-dots">...</span></p>
                        <p class="text-sm mt-1">This may take a few moments.</p>
                    </div>
                    <div class="mt-4">
                        <h3 class="font-semibold mb-2">Output Stream:</h3>
                        <div id="stream-output" class="bg-gray-800 text-gray-200 p-4 rounded overflow-auto max-h-96 font-mono text-sm whitespace-pre-wrap"></div>
                    </div>
                    <div class="mt-4 hidden" id="final-output-container">
                        <h3 class="font-semibold mb-2">Results:</h3>
                        <div id="token-info" class="bg-gray-700/50 p-3 rounded-md text-sm mb-2">
                            <div id="token-usage" class="text-gray-300"></div>
                            <div id="cost-info" class="text-green-400 mt-1"></div>
                        </div>
                    </div>
                `;
                
                const streamOutput = document.getElementById('stream-output');
                
                // Restart the loading animation after updating the HTML
                startLoadingAnimation();
                
                // Process the stream
                while (true) {
                    const { value, done } = await reader.read();
                    
                    if (done) break;
                    
                    // Decode and append to buffer
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Process complete data messages
                    const messages = buffer.split("\n\n");
                    // Keep the last potentially incomplete message in the buffer
                    buffer = messages.pop() || '';
                    
                    for (const message of messages) {
                        if (!message.startsWith('data:')) continue;
                        
                        try {
                            const jsonStr = message.substring(5).trim();
                            const data = JSON.parse(jsonStr);
                            
                            if (data.type === 'output') {
                                // Store output content
                                outputContent += data.content + '\n';
                                
                                // Display stream output in real-time
                                streamOutput.textContent += data.content + '\n';
                                
                                // Auto-scroll to bottom
                                streamOutput.scrollTop = streamOutput.scrollHeight;
                                
                                // Process token and cost information
                                if (data.content && data.content.includes('Tokens:')) {
                                    const content = data.content;
                                    
                                    // Extract token information
                                    const tokenMatch = content.match(/Tokens:(.*?)(?=Cost:|$)/i);
                                    if (tokenMatch && tokenMatch[1]) {
                                        const tokenInfo = tokenMatch[1].trim();
                                        document.getElementById('token-usage').innerHTML = `<span class="text-blue-400 font-medium">Tokens:</span> ${tokenInfo}`;
                                    }
                                    
                                    // Extract cost information
                                    const costMatch = content.match(/Cost:(.*?)(?=$)/i);
                                    if (costMatch && costMatch[1]) {
                                        const costInfo = costMatch[1].trim();
                                        document.getElementById('cost-info').innerHTML = `<span class="text-blue-400 font-medium">Cost:</span> ${costInfo}`;
                                    }
                                }
                                
                                // Check if this is the line with the modified file
                                if (data.content && data.content.includes('Modified') && data.content.includes(filename || 'temp_file.html')) {
                                    try {
                                        // Try to get the modified file content
                                        // Wait a bit for aider to finish writing
                                        setTimeout(async () => {
                                            try {
                                                const modifiedResponse = await fetch('/api/get-temp-file', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                    },
                                                    body: JSON.stringify({ temp_file_path: data.filePath })
                                                });
                                                
                                                if (modifiedResponse.ok) {
                                                    const modifiedData = await modifiedResponse.json();
                                                    if (modifiedData.content) {
                                                        // Show diff view
                                                        showDiffView(originalContent, modifiedData.content);
                                                    }
                                                }
                                            } catch (e) {
                                                console.error('Error getting modified file:', e);
                                            }
                                        }, 500);
                                    } catch (e) {
                                        console.error('Error parsing modified file path:', e);
                                    }
                                }
                            } else if (data.type === 'complete') {
                                // Stop the loading animation
                                stopLoadingAnimation();
                                
                                // Show the final output
                                document.getElementById('final-output-container').classList.remove('hidden');
                                
                                // Extract token and cost info for the final results display
                                let finalTokenInfo = '';
                                let finalCostInfo = '';
                                
                                // Look for token and cost info in the output
                                const tokenLines = outputContent.match(/Tokens:.*?(\n|$)/);
                                const costLines = outputContent.match(/Cost:.*?(\n|$)/);
                                
                                if (tokenLines && tokenLines[0]) finalTokenInfo = tokenLines[0].trim();
                                if (costLines && costLines[0]) finalCostInfo = costLines[0].trim();
                                
                                assistantOutput.innerHTML = `
                                    <div class="mt-4">
                                        <h3 class="font-semibold mb-2">Results:</h3>
                                        <div id="token-info" class="bg-gray-700/50 p-3 rounded-md text-sm mb-4">
                                            <div id="token-usage" class="text-blue-400">${finalTokenInfo}</div>
                                            <div id="cost-info" class="text-green-400 mt-1">${finalCostInfo}</div>
                                        </div>
                                        <button id="showDiffBtn" class="px-4 py-2 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all">
                                            Show Changes as Diff
                                        </button>
                                        <button id="revertBtn" onclick="undoAllChanges('${escapeHtml(originalContent)}')" 
                                            class="px-4 py-2 ml-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all">
                                            Revert Changes
                                        </button>
                                    </div>
                                `;
                                
                                // Get the final file content by reading the file that was modified
                                try {
                                    const finalFilePath = data.filePath;
                                    if (finalFilePath) {
                                        const fileResponse = await fetch('/api/get-temp-file', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            },
                                            body: JSON.stringify({ temp_file_path: finalFilePath })
                                        });
                                        
                                        if (fileResponse.ok) {
                                            const fileData = await fileResponse.json();
                                            if (fileData.content) {
                                                // Update editor with new content
                                                editor.setValue(fileData.content);
                                                updatePreview();
                                                
                                                // Setup diff view button
                                                document.getElementById('showDiffBtn').addEventListener('click', () => {
                                                    showDiffView(originalContent, fileData.content);
                                                });
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error('Error getting final file content:', e);
                                }
                                
                                // If we couldn't get the modified file, use a simple content scanning approach
                                if (!editor.getValue() || editor.getValue() === originalContent) {
                                    // Try to extract the modified content from the aider output
                                    const modifiedContent = extractModifiedContent(outputContent);
                                    if (modifiedContent) {
                                        editor.setValue(modifiedContent);
                                        updatePreview();
                                        
                                        // Setup diff view button event
                                        document.getElementById('showDiffBtn').addEventListener('click', () => {
                                            showDiffView(originalContent, modifiedContent);
                                        });
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Error parsing SSE message:', e, message);
                        }
                    }
                }
                
            } catch (error) {
                assistantOutput.innerHTML = `
                    <div class="p-4 bg-red-50 text-red-700 rounded">
                        Error: ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }
        
        function undoAllChanges(originalContent) {
            // Need to unescape the escaped content
            const unescaped = originalContent.replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
                
            editor.executeEdits('undo-all', [{
                range: editor.getModel().getFullModelRange(),
                text: unescaped,
                forceMoveMarkers: true
            }]);
            updatePreview();
        }

        function applyChanges() {
            // Get the modified content from the diff editor
            const modifiedContent = modifiedModel.getValue();
            
            // Update the main editor
            editor.setValue(modifiedContent);
            
            // Switch back to the main editor view
            document.getElementById('editor').classList.remove('hidden');
            document.getElementById('diffEditor').classList.add('hidden');
            document.getElementById('diffControls').classList.add('hidden');
            
            // Update the preview
            updatePreview();
        }

        function rejectChanges() {
            // Switch back to the main editor view without applying changes
            document.getElementById('editor').classList.remove('hidden');
            document.getElementById('diffEditor').classList.add('hidden');
            document.getElementById('diffControls').classList.add('hidden');
        }

        function resetEditorView() {
            document.getElementById('editor').classList.remove('hidden');
            document.getElementById('diffEditor').classList.add('hidden');
            document.getElementById('diffControls').classList.add('hidden');
        }

        function updatePreview() {
            const content = editor.getValue();
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const previewFrame = document.getElementById('previewFrame');
            previewFrame.src = url;
            previewFrame.onload = () => URL.revokeObjectURL(url);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Add language detection
        function detectLanguage(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const languageMap = {
                'js': 'javascript',
                'py': 'python',
                'html': 'html',
                'css': 'css',
                'json': 'json',
                'md': 'markdown',
                'sql': 'sql',
                'ts': 'typescript',
                'jsx': 'javascript',
                'tsx': 'typescript',
                'vue': 'html',
                'php': 'php',
                'rb': 'ruby',
                'go': 'go',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'cs': 'csharp',
                'rs': 'rust'
            };
            return languageMap[ext] || 'plaintext';
        }

        // Update editor language when filename changes
        document.getElementById('filename').addEventListener('input', function(e) {
            const language = detectLanguage(e.target.value);
            monaco.editor.setModelLanguage(editor.getModel(), language);
            monaco.editor.setModelLanguage(originalModel, language);
            monaco.editor.setModelLanguage(modifiedModel, language);
        });

        // Add these functions to the script section
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                displaySelectedImage(file);
            }
        }

        function displaySelectedImage(file) {
            document.getElementById('selectedImageName').textContent = file.name || 'Pasted image';
            
            // Preview the image
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImg');
                previewImg.src = e.target.result;
                document.getElementById('imagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            document.getElementById('imageUpload').value = '';
            document.getElementById('selectedImageName').textContent = 'No image selected';
            document.getElementById('imagePreview').classList.add('hidden');
            // Clear any pasted image data
            window.pastedImageFile = null;
        }

        // Add paste event handler
        function handlePaste(e) {
            // Only process paste if image context is enabled
            if (!document.getElementById('useImageContext').checked) return;
            
            // Check if the paste event has image data
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let imageFile = null;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') === 0) {
                    imageFile = items[i].getAsFile();
                    break;
                }
            }
            
            if (imageFile) {
                // Store the file for later use
                window.pastedImageFile = imageFile;
                
                // Display the image preview
                displaySelectedImage(imageFile);
                
                // Show the image container if it's hidden
                document.getElementById('imageUploadContainer').classList.remove('hidden');
                
                // If the paste happened outside the textarea, don't interfere with normal paste
                if (e.target.id !== 'editRequest') {
                    e.preventDefault();
                }
            }
        }

        // Add these event listeners to the script section, near the end
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('useImageContext').addEventListener('change', function(e) {
                if (e.target.checked) {
                    document.getElementById('imageUploadContainer').classList.remove('hidden');
                } else {
                    document.getElementById('imageUploadContainer').classList.add('hidden');
                }
            });
            
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
            
            // Add paste event listener to document for capturing paste anywhere
            document.addEventListener('paste', handlePaste);
            
            // Initialize pastedImageFile variable
            window.pastedImageFile = null;
        });

        // Add new function to show diff view
        function showDiffView(originalContent, modifiedContent) {
            // Hide the regular editor and show the diff editor
            document.getElementById('editor').classList.add('hidden');
            document.getElementById('diffEditor').classList.remove('hidden');
            document.getElementById('diffControls').classList.remove('hidden');
            
            // Set the content for both models
            originalModel.setValue(originalContent);
            modifiedModel.setValue(modifiedContent);
        }

        // Add function to extract modified content from aider output
        function extractModifiedContent(outputText) {
            // This is a simple heuristic to extract the modified code
            // It looks for code blocks in markdown format (```language...```)
            const codeBlockRegex = /```(?:html|javascript|python|css|[a-z]+)?\s*([\s\S]*?)\s*```/g;
            const matches = [...outputText.matchAll(codeBlockRegex)];
            
            if (matches.length > 0) {
                // Return the last code block (most likely the final result)
                return matches[matches.length - 1][1];
            }
            
            return null;
        }

        // Add these new functions for the loading animation
        let loadingInterval;

        function startLoadingAnimation() {
            const loadingDotsElement = document.getElementById('loading-dots');
            if (!loadingDotsElement) return;
            
            let dotCount = 0;
            
            // Clear any existing interval
            if (loadingInterval) clearInterval(loadingInterval);
            
            // Start new animation interval
            loadingInterval = setInterval(() => {
                dotCount = (dotCount % 3) + 1;
                const dots = '.'.repeat(dotCount);
                loadingDotsElement.textContent = dots;
            }, 500); // Change dots every 500ms
        }

        function stopLoadingAnimation() {
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
        }
    </script>
</body>
</html>
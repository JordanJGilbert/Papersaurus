<!DOCTYPE html>
<html>
<head>
    <title>Set Your Timezone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans">
    <div class="w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-lg p-8 space-y-6">
            <div class="space-y-2">
                <h1 class="text-2xl font-semibold text-gray-900">Set Your Timezone</h1>
                <p class="text-gray-600">Please select your timezone to ensure accurate reminder times:</p>
            </div>
            
            <div id="location-info" class="hidden bg-blue-50 p-4 rounded-xl space-y-2">
                <p class="text-blue-700 font-medium">üìç Your Location:</p>
                <p id="location-text" class="text-blue-600"></p>
            </div>
            
            <select id="timezone" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                <!-- Will be populated by JavaScript -->
            </select>
            
            <p class="text-gray-600">
                Current time in selected timezone: 
                <span id="current-time" class="font-medium text-gray-900"></span>
            </p>
            
            <button onclick="saveTimezone()" class="w-full bg-blue-500 hover:bg-blue-600 active:bg-blue-700 text-white font-medium px-6 py-3 rounded-xl transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Save Timezone
            </button>
            
            <p id="success" class="hidden text-green-600 text-center bg-green-50 py-3 px-4 rounded-xl">
                ‚úÖ Timezone saved successfully! You can close this page.
            </p>
            <p id="error" class="hidden text-red-600 text-center bg-red-50 py-3 px-4 rounded-xl">
                ‚ùå Error saving timezone. Please try again.
            </p>
        </div>
    </div>

    <script>
        // Get token from server-side
        const token = "{{ token }}";
        
        // Populate timezone select
        const select = document.getElementById('timezone');
        const zones = Intl.supportedValuesOf('timeZone');
        
        zones.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone;
            option.text = zone;
            select.appendChild(option);
        });
        
        // Try to detect user's timezone
        const detectedZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        select.value = detectedZone;
        
        // Get user's location
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(async function(position) {
                try {
                    // Use reverse geocoding to get location details
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`
                    );
                    const data = await response.json();
                    
                    // Extract relevant location information
                    const address = data.address;
                    let locationText = [];
                    
                    if (address.city || address.town || address.village) {
                        locationText.push(address.city || address.town || address.village);
                    }
                    if (address.state) {
                        locationText.push(address.state);
                    }
                    if (address.country) {
                        locationText.push(address.country);
                    }
                    
                    // Display location
                    document.getElementById('location-text').textContent = locationText.join(', ');
                    document.getElementById('location-info').classList.remove('hidden');
                    
                } catch (error) {
                    console.error('Error getting location details:', error);
                }
            }, function(error) {
                console.error('Error getting location:', error);
            }, {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            });
        }
        
        // Update current time display
        function updateTime() {
            const selectedZone = select.value;
            const now = luxon.DateTime.now().setZone(selectedZone);
            document.getElementById('current-time').textContent = now.toFormat('ff');
        }
        
        select.addEventListener('change', updateTime);
        updateTime();
        setInterval(updateTime, 1000);
        
        async function saveTimezone() {
            try {
                // Get location data if available
                const locationText = document.getElementById('location-text').textContent;
                const locationData = locationText ? {
                    city: locationText.split(', ')[0] || '',
                    state: locationText.split(', ')[1] || '',
                    country: locationText.split(', ')[2] || ''
                } : null;
                
                const response = await fetch('/signal/api/set-timezone', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token,
                        timezone: select.value,
                        location: locationData
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('success').classList.remove('hidden');
                    document.getElementById('error').classList.add('hidden');
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('success').classList.add('hidden');
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html> 
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Enhanced base styles */
        body {
            background: linear-gradient(145deg, #FEF2F2 0%, #ffffff 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            -webkit-font-smoothing: antialiased;
            color: #1d1d1f;
            letter-spacing: -0.01em;
        }

        /* Modal styling with glassmorphism */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 24px 64px rgba(0, 0, 0, 0.1),
                0 2px 4px rgba(0, 0, 0, 0.02);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-modal {
            position: fixed;
            right: 1.5rem;
            top: 1.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 60;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #86868b;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.05);
            color: #1d1d1f;
        }

        .close-modal:active {
            transform: scale(0.95);
        }

        .close-modal::before,
        .close-modal::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 1px;
            background: currentColor;
            transform-origin: center;
        }

        .close-modal::before {
            transform: rotate(45deg);
        }

        .close-modal::after {
            transform: rotate(-45deg);
        }

        .modal-image-container {
            width: 100%;
            max-height: 40vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            background: #f7f7f7;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .modal-image {
            max-width: 100%;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 0.25rem;
        }

        .modal-metadata {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem 0;
        }

        .metadata-item {
            width: 100%;
            background: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .metadata-label {
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 2px solid #E5E7EB;
        }

        .metadata-value {
            color: #1F2937;
            font-size: 0.9375rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Enhanced message bubbles */
        .message-bubble {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            border: none;
            box-shadow: 
                0 2px 8px rgba(0, 122, 255, 0.15),
                0 1px 2px rgba(0, 122, 255, 0.1);
        }

        .messages-wrapper {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1rem;
        }

        /* Refined section card styling */
        .section-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 4px 24px rgba(0, 0, 0, 0.03),
                0 1px 2px rgba(0, 0, 0, 0.02);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .section-card:hover {
            transform: translateY(-1px);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.05),
                0 1px 2px rgba(0, 0, 0, 0.03);
        }

        /* Enhanced section header */
        .section-header {
            padding: 1.75rem;
            border-radius: 20px;
            transition: all 0.2s ease;
        }

        .section-header:hover {
            background: rgba(255, 255, 255, 0.7);
        }

        /* Updated scrollbar styling */
        .messages-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .messages-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-wrapper::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        /* Updated message styles for better UX */
        .message-container {
            display: flex;
            flex-direction: column;
            gap: 0.0625rem;
            padding: 0.0625rem 0;
        }

        .message-timestamp {
            font-size: 0.625rem;
            color: #8E8E93;
            text-align: right;
            margin: 0 0.375rem;
            opacity: 0.8;
        }

        .date-separator {
            position: relative;
            text-align: center;
            margin: 0.75rem 0;
            z-index: 1;
        }

        .date-separator::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background-color: #E5E5EA;
            z-index: -1;
        }

        .date-separator span {
            background-color: #F2F2F7;
            padding: 0 0.75rem;
            font-size: 0.75rem;
            color: #8E8E93;
            font-weight: 500;
        }

        /* Add smooth scrolling for messages container */
        .messages-wrapper {
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Style scrollbar for better visual integration */
        .messages-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .messages-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-wrapper::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        /* Optimize for mobile */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 90%;
                font-size: 0.875rem;
            }

            .messages-wrapper {
                padding: 0.5rem;
            }
        }

        .transform {
            transition: transform 0.2s ease-in-out;
        }

        .rotate-180 {
            transform: rotate(180deg);
        }

        /* Add styles for better mobile interaction */
        .section-header {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            position: relative;
            z-index: 10;
            background: white;
            margin: -0.75rem -1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
        }

        .section-header:active {
            background-color: #f3f4f6;
        }

        .section-content {
            position: relative;
            z-index: 5;
            margin-top: 1rem;
        }

        /* Prevent image clicks from interfering with section toggle */
        .grid-image {
            pointer-events: none;
        }
        
        .image-wrapper {
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .section-header {
                padding: 1rem;
            }
        }

        /* Refined message bubbles */
        .message-container .max-w-[85%] {
            background: #007AFF;
            background: linear-gradient(135deg, #0A84FF 0%, #007AFF 100%);
            border-radius: 18px 18px 4px 18px;
            padding: 10px 14px;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
        }

        /* Refined typography */
        h1 {
            letter-spacing: -0.02em;
        }

        .section-header h2 {
            letter-spacing: -0.01em;
        }

        .delete-btn {
            transition: opacity 0.2s ease;
        }

        .message-container:hover .delete-btn {
            opacity: 1;
        }

        /* Add styles for bulk selection */
        .selection-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 20px;
            height: 20px;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .image-wrapper:hover .selection-checkbox,
        .message-container:hover .selection-checkbox {
            opacity: 1;
        }

        .bulk-actions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 12px 24px;
            border-radius: 50px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 100;
            color: white;
        }

        .bulk-actions.visible {
            display: flex;
        }

        .bulk-delete-btn {
            background: #dc2626;
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .bulk-delete-btn:hover {
            background: #b91c1c;
        }

        /* Refined image wrapper */
        .image-wrapper {
            @apply aspect-square relative group rounded-2xl overflow-hidden;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .image-wrapper:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }

        /* Modal styling refinements */
        .modal-content {
            @apply max-w-3xl mx-auto;
        }

        .metadata-item {
            @apply bg-gray-50 rounded-lg p-4 mb-3;
        }

        .metadata-label {
            @apply text-sm font-semibold text-gray-700 mb-1;
        }

        .metadata-value {
            @apply text-gray-600 text-sm whitespace-pre-wrap;
        }

        /* Search results styling */
        #results-container .image-wrapper {
            @apply aspect-square relative group rounded-lg overflow-hidden cursor-pointer;
            max-width: 160px;
            min-width: 100px;
        }

        #results-container .image-wrapper img {
            @apply w-full h-full object-cover transition-transform duration-200;
        }

        #results-container .image-wrapper:hover img {
            @apply scale-105;
        }

        #results-container .image-overlay {
            @apply absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-200 
                   flex items-center justify-center text-white text-sm font-medium;
        }

        #results-container .image-wrapper:hover .image-overlay {
            @apply opacity-100;
        }

        /* Refined search input */
        #search-input {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.02),
                0 1px 2px rgba(0, 0, 0, 0.01);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-gray-50 to-white p-6 md:p-12">
    <div class="max-w-7xl mx-auto">
        <!-- Enhanced Header Section -->
        <div class="mb-12">
            <h1 class="text-4xl md:text-5xl font-semibold text-gray-900 tracking-tight mb-3">
                Your Database
            </h1>
            <p class="text-sm text-gray-500 tracking-wide">
                Database for $sender_display
            </p>
        </div>
        
        <!-- Refined Search Section -->
        <div class="mb-12 max-w-2xl">
            <div class="relative group">
                <input type="text" 
                       id="search-input" 
                       class="w-full px-6 py-4 pr-12 text-gray-700 placeholder-gray-400 rounded-2xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                       placeholder="Search your database...">
                <button onclick="handleSearch()" 
                        class="absolute right-4 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
            </div>
            <!-- Add search status element -->
            <div id="search-status" class="mt-3 text-sm text-gray-500 hidden"></div>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="space-y-6 mb-8 hidden">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-900">Search Results</h2>
                
                <!-- Add AI Analysis section -->
                <div class="flex items-center gap-3">
                    <input type="text" 
                           id="batch-analysis-input" 
                           class="px-4 py-2 text-sm text-gray-700 placeholder-gray-400 bg-white/80 backdrop-blur-sm border border-gray-200 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent transition-all duration-200"
                           placeholder="Ask AI about these results...">
                    <button onclick="analyzeBatchResults()" 
                            class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors text-sm font-medium">
                        Analyze
                    </button>
                    <button onclick="clearBatchAnalysis()" 
                            class="px-4 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-colors text-sm font-medium">
                        Clear
                    </button>
                </div>
            </div>
            
            <!-- Add AI Analysis results section -->
            <div id="batch-analysis-results" class="hidden">
                <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-gray-200 p-6 mt-4">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">AI Analysis</h3>
                    
                    <!-- Summary Section -->
                    <div class="mb-6">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Summary</h4>
                        <div id="batch-analysis-summary" class="prose prose-sm max-w-none bg-gray-50 rounded-lg p-4">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>

                    <!-- Individual Results Section -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Individual Analysis</h4>
                        <div id="batch-analysis-individual" class="grid grid-cols-1 gap-3">
                            <!-- Individual results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="results-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3">
                <!-- Search results will be populated here -->
            </div>
        </div>
        
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <!-- Messages Section -->
            <div class="section-card bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="section-header hover:bg-gray-50/50 transition-colors p-6" onclick="toggleSection('messages-content')">
                    <div class="w-full flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="p-2 rounded-xl bg-red-50 text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                                </svg>
                            </span>
                            <h2 class="text-xl font-semibold text-gray-900">Text Messages</h2>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 transform transition-transform duration-200" id="messages-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                        </svg>
                    </div>
                </div>
                <div class="section-content hidden px-6 pb-6" id="messages-content">
                    <div class="messages-wrapper max-h-[600px] overflow-y-auto rounded-xl bg-white/50 backdrop-blur-sm border border-gray-100 p-4"></div>
                </div>
            </div>

            <!-- Images Section -->
            <div class="section-card bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="section-header hover:bg-gray-50/50 transition-colors p-6" onclick="toggleSection('images-content')">
                    <div class="w-full flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="p-2 rounded-xl bg-red-50/70 text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                            </span>
                            <h2 class="text-xl font-semibold text-gray-900">Images</h2>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 transform transition-transform duration-200" id="images-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                        </svg>
                    </div>
                </div>
                <div class="section-content hidden px-6 pb-6" id="images-content">
                    <div class="grid grid-cols-1 gap-3 auto-rows-fr">
                        <!-- Images will be populated here -->
                    </div>
                </div>
            </div>

            <!-- AI Generated Images Section -->
            <div class="section-card bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="section-header hover:bg-gray-50/50 transition-colors p-6" onclick="toggleSection('ai-images-content')">
                    <div class="w-full flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="p-2 rounded-xl bg-red-50/50 text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                            </span>
                            <h2 class="text-xl font-semibold text-gray-900">AI Generated Images</h2>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 transform transition-transform duration-200" id="ai-images-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                        </svg>
                    </div>
                </div>
                <div class="section-content hidden px-6 pb-6" id="ai-images-content">
                    <div class="grid grid-cols-1 gap-3 auto-rows-fr">
                        <!-- AI Images will be populated here -->
                    </div>
                </div>
            </div>

            <!-- PDFs Section -->
            <div class="section-card bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="section-header hover:bg-gray-50/50 transition-colors p-6" onclick="toggleSection('pdfs-content')">
                    <div class="w-full flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="p-2 rounded-xl bg-red-50 text-red-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                </svg>
                            </span>
                            <h2 class="text-xl font-semibold text-gray-900">PDFs</h2>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 transform transition-transform duration-200" id="pdfs-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                        </svg>
                    </div>
                </div>
                <div class="section-content hidden px-6 pb-6" id="pdfs-content">
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                </div>
            </div>

            <!-- Reminders Section -->
            <div class="section-card bg-white/80 backdrop-blur-md rounded-2xl shadow-sm border border-gray-100 overflow-hidden mt-8">
                <div class="section-header hover:bg-gray-50/50 transition-colors p-6" onclick="toggleSection('reminders-content')">
                    <div class="w-full flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <span class="p-2 rounded-xl bg-yellow-50 text-yellow-600">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </span>
                            <h2 class="text-xl font-semibold text-gray-900">Active Reminders</h2>
                        </div>
                        <svg class="w-6 h-6 text-gray-400 transform transition-transform duration-200" id="reminders-arrow" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M7 10l5 5 5-5z"/>
                        </svg>
                    </div>
                </div>
                <div class="section-content hidden px-6 pb-6" id="reminders-content">
                    <div class="grid gap-4" id="reminders-grid">
                        <!-- Reminders will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulk-actions" class="bulk-actions">
        <div class="flex items-center gap-4 px-6 py-3 bg-gray-900/90 backdrop-blur-lg rounded-full text-white">
            <span id="selected-count" class="text-sm font-medium">0 items selected</span>
            <button onclick="deleteSelectedItems()" 
                    class="px-4 py-1.5 bg-red-500 hover:bg-red-600 rounded-full text-sm font-medium transition-colors">
                Delete Selected
            </button>
        </div>
    </div>

    <!-- Modal -->
    <div id="metadata-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()" aria-label="Close modal"></span>
            <h2 class="text-xl font-bold mb-4" id="modal-title">Image Details</h2>
            <div class="modal-image-container">
                <img id="modal-image" class="modal-image" src="" alt="Image">
            </div>
            <div id="modal-metadata" class="modal-metadata">
                <!-- Metadata will be populated here -->
                <div class="metadata-item">
                    <div class="metadata-label">Timestamp</div>
                    <div class="metadata-value" id="modal-timestamp"></div>
                </div>
                <div class="metadata-item" id="prompt-container">
                    <div class="metadata-label">Prompt</div>
                    <div class="metadata-value" id="modal-prompt"></div>
                </div>
                <div class="metadata-item" id="ai-response-container">
                    <div class="metadata-label">AI Analysis</div>
                    <div class="metadata-value prose prose-sm" id="modal-ai-response"></div>
                </div>
            </div>
            
            <!-- Add AI interaction section -->
            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-semibold mb-2">Ask AI about this item</h3>
                <div class="flex gap-2">
                    <input type="text" 
                           id="ai-prompt" 
                           class="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="Ask a question about this item...">
                    <button onclick="askAI()" 
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        Ask AI
                    </button>
                </div>
                <div id="ai-response" class="mt-3 p-3 bg-white rounded-lg border hidden">
                    <div class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this toast container div right after the <body> tag -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

    <script>
        // Format timestamp in user's local timezone
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            return date.toLocaleString(undefined, {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        function toggleSection(id) {
            const content = document.getElementById(id);
            const arrow = document.getElementById(id.replace('content', 'arrow'));
            
            if (!content || !arrow) return;
            
            // Toggle content visibility
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                arrow.classList.remove('rotate-180');
            }
        }

        // Update the fetchAttachmentData function
        async function fetchAttachmentData(attachment_key) {
            console.log('Fetching attachment for key:', attachment_key);
            try {
                const response = await fetch(`/read?key=${attachment_key}`);
                if (!response.ok) {
                    console.error('Fetch failed with status:', response.status);
                    throw new Error('Failed to fetch attachment');
                }
                const data = await response.json();
                
                if (!data.value || !data.value.type || !data.value.data) {
                    console.error('Invalid attachment data structure:', data);
                    return null;
                }
                
                console.log('Successfully fetched attachment:', {
                    type: data.value.type,
                    hasData: !!data.value.data
                });
                
                return data.value;
            } catch (error) {
                console.error('Error fetching attachment:', error);
                return null;
            }
        }

        fetch('/read?key=database-${sender}')
            .then(response => response.json())
            .then(async data => {
                const conversation = data.value || {};
                const messages = conversation.messages || [];
                
                // Add debug logging
                console.log('Messages with attachments:', messages.filter(m => m.attachments?.length > 0));
                
                const messagesWrapper = document.querySelector('.messages-wrapper');
                if (messages.length === 0) {
                    messagesWrapper.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No messages yet</p>';
                } else {
                    let currentDate = null;
                    // Reverse messages to show newest at bottom
                    for (const msg of [...messages].reverse()) {
                        const messageDate = new Date(msg.timestamp);
                        const dateStr = messageDate.toLocaleDateString('en-US', { 
                            weekday: 'short',
                            month: 'short',
                            day: 'numeric',
                            year: messageDate.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined
                        });

                        // Add date separator if it's a new day
                        if (dateStr !== currentDate) {
                            const dateDiv = document.createElement('div');
                            dateDiv.className = 'date-separator';
                            dateDiv.innerHTML = `
                                <div class="relative text-center my-3 z-10">
                                    <div class="absolute inset-0 flex items-center">
                                        <div class="w-full border-t border-[#E5E5EA]"></div>
                                    </div>
                                    <span class="bg-[#F2F2F7] px-3 text-xs text-[#8E8E93] font-medium relative">
                                        ${dateStr}
                                    </span>
                                </div>
                            `;
                            messagesWrapper.appendChild(dateDiv);
                            currentDate = dateStr;
                        }

                        const messageContainer = document.createElement('div');
                        messageContainer.className = 'message-container group relative hover:bg-gray-50/50 rounded-lg transition-colors p-2';

                        const timeStr = messageDate.toLocaleTimeString('en-US', { 
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        }).toLowerCase();

                        // Fetch attachment data if message has attachments
                        let attachmentHtml = '';
                        if (msg.attachments && msg.attachments.length > 0) {
                            for (const attachment of msg.attachments) {
                                // Use the attachment key directly
                                const attachmentData = await fetchAttachmentData(attachment.key);
                                if (attachmentData && attachmentData.type && attachmentData.type.startsWith('image/')) {
                                    attachmentHtml += `
                                        <div class="mt-2 border-t border-white/20 pt-2">
                                            <img src="data:${attachmentData.type};base64,${attachmentData.data}" 
                                                 class="max-w-full rounded mt-2 cursor-pointer" 
                                                 alt="Attached image"
                                                 onclick="showImageModal('${attachment.key}', {
                                                     timestamp: '${msg.timestamp}',
                                                     type: '${attachmentData.type}'
                                                 }, 'regular')">
                                        </div>
                                    `;
                                }
                            }
                        }

                        // Also fetch AI response attachments if they exist
                        let aiAttachmentHtml = '';
                        if (msg.ai_response && msg.ai_response.attachments && msg.ai_response.attachments.length > 0) {
                            for (const attachment of msg.ai_response.attachments) {
                                // Use the AI attachment key directly
                                const attachmentData = await fetchAttachmentData(attachment.key);
                                if (attachmentData && attachmentData.type && attachmentData.type.startsWith('image/')) {
                                    aiAttachmentHtml += `
                                        <div class="mt-2 border-t border-gray-300/20 pt-2">
                                            <img src="data:${attachmentData.type};base64,${attachmentData.data}" 
                                                 class="max-w-full rounded mt-2 cursor-pointer"
                                                 alt="AI generated image"
                                                 onclick="showImageModal('${attachment.key}', {
                                                     timestamp: '${msg.ai_response.timestamp}',
                                                     type: '${attachmentData.type}',
                                                     prompt: '${msg.text}'
                                                 }, 'ai')">
                                        </div>
                                    `;
                                }
                            }
                        }

                        messageContainer.innerHTML = `
                            <input type="checkbox" 
                                   class="selection-checkbox absolute left-2 top-2" 
                                   onclick="toggleItemSelection('${msg.key}', 'messages', event)">
                            <div class="flex justify-between items-start gap-2 pl-6">
                                <div class="max-w-[85%] space-y-2">
                                    <!-- User message -->
                                    <div class="p-3 rounded-2xl rounded-tr-sm bg-[#007AFF] text-white shadow-sm">
                                        ${msg.text}
                                        ${attachmentHtml}
                                    </div>
                                    ${msg.ai_response ? `
                                        <!-- AI response -->
                                        <div class="p-3 rounded-2xl rounded-tl-sm bg-gray-200 text-gray-800 shadow-sm">
                                            ${msg.ai_response.text}
                                            ${aiAttachmentHtml}
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <button onclick="deleteItem('messages', '${msg.key}')" 
                                        class="delete-btn opacity-0 group-hover:opacity-100 p-1.5 text-red-500 hover:text-red-600 transition-opacity">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                            <div class="text-[10px] text-[#8E8E93] text-right mx-1.5 opacity-80">
                                ${timeStr}
                            </div>
                        `;
                        messagesWrapper.appendChild(messageContainer);
                    }

                    // Scroll to bottom of messages
                    setTimeout(() => {
                        messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
                    }, 100);
                }
            });

        let currentItemData = null;
        let selectedItems = new Map(); // Store selected items: {timestamp: type}

        function showModal(imageData, metadata, type) {
            const modal = document.getElementById('metadata-modal');
            const modalImageContainer = document.querySelector('.modal-image-container');
            const modalTitle = document.getElementById('modal-title');
            const modalTimestamp = document.getElementById('modal-timestamp');
            const modalPrompt = document.getElementById('modal-prompt');
            const modalAiResponse = document.getElementById('modal-ai-response');
            const promptContainer = document.getElementById('prompt-container');
            const aiResponseContainer = document.getElementById('ai-response-container');

            // Create new image element
            modalImageContainer.innerHTML = `<img id="modal-image" class="modal-image" src="" alt="Image">`;
            const modalImage = document.getElementById('modal-image');
            
            // Set image source
            modalImage.src = `data:${metadata.type};base64,${imageData.data}`;
            
            // Set modal title based on type
            modalTitle.textContent = type === 'ai' ? 'AI Generated Image Details' : 'Image Details';
            
            // Set timestamp
            modalTimestamp.textContent = formatTimestamp(metadata.timestamp);
            
            // Handle prompt and AI response visibility
            if (type === 'ai' && metadata.prompt) {
                promptContainer.style.display = 'block';
                modalPrompt.textContent = metadata.prompt;
            } else {
                promptContainer.style.display = 'none';
            }
            
            if (metadata.ai_response) {
                aiResponseContainer.style.display = 'block';
                modalAiResponse.textContent = metadata.ai_response;
            } else {
                aiResponseContainer.style.display = 'none';
            }
            
            // Show modal
            modal.style.display = 'block';
        }

        function closeModal() {
            const modal = document.getElementById('metadata-modal');
            const modalImageContainer = document.querySelector('.modal-image-container');
            modalImageContainer.innerHTML = ''; // Clear the container
            modal.style.display = 'none';
            
            // Clear AI response input and response
            const aiPrompt = document.getElementById('ai-prompt');
            const aiResponse = document.getElementById('ai-response');
            if (aiPrompt) aiPrompt.value = '';
            if (aiResponse) {
                aiResponse.classList.add('hidden');
                aiResponse.querySelector('div').textContent = '';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('metadata-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        async function askAI() {
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt || !currentItemData) return;

            const responseDiv = document.getElementById('ai-response');
            const responseContent = responseDiv.querySelector('div');
            
            // Show loading state
            responseDiv.classList.remove('hidden');
            responseContent.innerHTML = 'Thinking...';
            
            try {
                const response = await fetch('signal/api/analyze_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: currentItemData.type,
                        prompt: prompt,
                        metadata: currentItemData.metadata,
                        data: currentItemData.data
                    })
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // Use marked to render markdown
                    responseContent.innerHTML = marked.parse(result.response);
                } else {
                    responseContent.innerHTML = 'Sorry, I could not analyze this item.';
                }
            } catch (error) {
                console.error('Error asking AI:', error);
                responseContent.innerHTML = 'An error occurred while processing your request.';
            }
        }

        async function deleteItem(type, timestamp) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            try {
                const response = await fetch('/signal/api/delete_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: '${sender}',  // Use the dynamic key
                        type: type,
                        timestamp: timestamp
                    })
                });

                if (response.ok) {
                    // Refresh the page to show updated content
                    window.location.reload();
                } else {
                    alert('Failed to delete item. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting item:', error);
                alert('Error deleting item. Please try again.');
            }
        }

        function toggleItemSelection(timestamp, type, event) {
            event.stopPropagation(); // Prevent triggering other click events
            
            if (selectedItems.has(timestamp)) {
                selectedItems.delete(timestamp);
            } else {
                selectedItems.set(timestamp, type);
            }
            
            // Update bulk actions bar visibility
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            if (selectedItems.size > 0) {
                bulkActions.classList.add('visible');
                selectedCount.textContent = `${selectedItems.size} item${selectedItems.size === 1 ? '' : 's'} selected`;
            } else {
                bulkActions.classList.remove('visible');
            }
        }

        async function deleteSelectedItems() {
            if (!confirm(`Are you sure you want to delete ${selectedItems.size} item${selectedItems.size === 1 ? '' : 's'}?`)) {
                return;
            }

            const deletePromises = Array.from(selectedItems.entries()).map(([timestamp, type]) =>
                fetch('/signal/api/delete_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        key: '${sender}',  // Use the dynamic key
                        type: type,
                        timestamp: timestamp
                    })
                })
            );

            try {
                await Promise.all(deletePromises);
                // Clear selection and refresh page
                selectedItems.clear();
                window.location.reload();
            } catch (error) {
                console.error('Error deleting items:', error);
                alert('Failed to delete some items. Please try again.');
            }
        }

        // Add search functionality
        async function handleSearch() {
            const searchInput = document.getElementById('search-input');
            const searchStatus = document.getElementById('search-status');
            const searchResults = document.getElementById('search-results');
            const resultsContainer = document.getElementById('results-container');
            
            const query = searchInput.value.trim();
            if (!query) return;
            
            // Show loading state
            searchStatus.textContent = "Searching...";
            searchStatus.classList.remove('hidden');
            searchResults.classList.add('hidden');
            
            try {
                const response = await fetch('/signal/api/analyze_item', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'query',
                        prompt: query,
                        metadata: { query: query },
                        key: '${sender}'  // Use the dynamic key
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success' && data.matches) {
                    // Clear previous results
                    resultsContainer.innerHTML = '';
                    
                    // Filter only matching items
                    const matchingItems = data.matches.filter(match => match.matches);
                    
                    if (matchingItems.length > 0) {
                        // Display results
                        matchingItems.forEach(async match => {
                            const item = match.item;
                            const resultCard = document.createElement('div');
                            resultCard.className = 'image-wrapper';
                            
                            // If there's a file key, fetch the file data
                            if (item.content.file_key) {
                                try {
                                    const fileData = await fetchFileData(item.content.file_key);
                                    if (fileData) {
                                        // Check if it's a PDF or image
                                        if (item.content.type === 'application/pdf') {
                                            resultCard.innerHTML = `
                                                <div class="aspect-[3/4] bg-white rounded-lg shadow-sm border overflow-hidden">
                                                    <iframe 
                                                        src="data:application/pdf;base64,${fileData.data}#toolbar=0&navpanes=0&scrollbar=0" 
                                                        class="w-full h-full"
                                                        title="PDF Preview">
                                                    </iframe>
                                                    <div class="image-overlay">
                                                        <span>Click to view details</span>
                                                    </div>
                                                </div>
                                            `;
                                        } else {
                                            // Original image handling
                                            resultCard.innerHTML = `
                                                <img src="data:${item.content.type};base64,${fileData.data}" 
                                                     class="w-full h-full object-cover rounded-lg cursor-pointer"
                                                     alt="Search result">
                                                <div class="image-overlay">
                                                    <span>Click to view details</span>
                                                </div>
                                            `;
                                        }
                                        
                                        // Add click handler for modal
                                        resultCard.onclick = () => showImageModal(
                                            item.content.file_key, 
                                            {
                                                timestamp: item.timestamp,
                                                type: item.content.type
                                            },
                                            item.content.type === 'application/pdf' ? 'pdf' : 
                                                item.content.type.includes('ai') ? 'ai' : 'regular'
                                        );
                                    }
                                } catch (e) {
                                    console.error('Error fetching file:', e);
                                }
                            }
                            
                            // Add file key attribute
                            resultCard.setAttribute('data-file-key', item.content.file_key);
                            resultCard.setAttribute('data-timestamp', item.timestamp);
                            resultCard.setAttribute('data-type', item.content.type);
                            resultCard.setAttribute('data-metadata', JSON.stringify(item.content));
                            
                            resultsContainer.appendChild(resultCard);
                        });
                        
                        searchResults.classList.remove('hidden');
                        searchStatus.textContent = `Found ${matchingItems.length} matching items`;
                    } else {
                        searchStatus.textContent = "No matching items found";
                    }
                } else {
                    searchStatus.textContent = "No matching items found";
                }
            } catch (error) {
                console.error('Error searching:', error);
                searchStatus.textContent = "Error performing search";
            }
        }

        // Add keyboard shortcut for search
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });

        // Handle escape key to close modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });

        async function analyzeBatchResults() {
            const analysisPrompt = document.getElementById('batch-analysis-input').value;
            if (!analysisPrompt) {
                alert('Please enter a question or analysis prompt');
                return;
            }

            const analysisResults = document.getElementById('batch-analysis-results');
            const summaryContainer = document.getElementById('batch-analysis-summary');
            const individualContainer = document.getElementById('batch-analysis-individual');
            
            // Show loading state
            analysisResults.classList.remove('hidden');
            summaryContainer.innerHTML = '<div class="animate-pulse">Analyzing results...</div>';
            individualContainer.innerHTML = '';

            try {
                // Get all the currently displayed results
                const currentResults = Array.from(document.querySelectorAll('#results-container .image-wrapper'))
                    .map(wrapper => {
                        return {
                            fileKey: wrapper.getAttribute('data-file-key'),
                            timestamp: wrapper.getAttribute('data-timestamp'),
                            type: wrapper.getAttribute('data-type'),
                            metadata: JSON.parse(wrapper.getAttribute('data-metadata') || '{}')
                        };
                    });

                // Send to backend for batch analysis
                const response = await fetch('/signal/api/analyze_batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        items: currentResults,
                        prompt: analysisPrompt
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    // Display summary with markdown
                    summaryContainer.innerHTML = marked.parse(data.summary);
                    
                    // Display individual results with markdown
                    individualContainer.innerHTML = '';
                    data.individual_results.forEach((result, index) => {
                        const resultElement = document.createElement('div');
                        resultElement.className = 'flex items-start gap-3 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
                        
                        resultElement.innerHTML = `
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-red-100 text-red-600 flex items-center justify-center text-sm font-medium">
                                ${index + 1}
                            </div>
                            <div class="flex-grow text-gray-700 text-sm prose prose-sm">
                                ${marked.parse(result)}
                            </div>
                        `;
                        
                        individualContainer.appendChild(resultElement);
                    });
                } else {
                    summaryContainer.innerHTML = 'Error analyzing results: ' + data.message;
                    individualContainer.innerHTML = '';
                }
            } catch (error) {
                console.error('Error analyzing batch results:', error);
                summaryContainer.innerHTML = 'An error occurred while analyzing the results.';
                individualContainer.innerHTML = '';
            }
        }

        function clearBatchAnalysis() {
            const analysisResults = document.getElementById('batch-analysis-results');
            const summaryContainer = document.getElementById('batch-analysis-summary');
            const individualContainer = document.getElementById('batch-analysis-individual');
            const analysisInput = document.getElementById('batch-analysis-input');
            
            // Clear the input and results
            analysisInput.value = '';
            analysisResults.classList.add('hidden');
            summaryContainer.innerHTML = '';
            individualContainer.innerHTML = '';
        }

        // Helper function to format recurrence info
        function formatRecurrence(recurrence) {
            if (!recurrence || recurrence.type === 'none') return '';
            
            // Format time using the stored hour and minute
            const hour = recurrence.hour;
            const minute = recurrence.minute;
            if (hour === undefined || minute === undefined) return '';
            
            // Create date object using current date but with reminder's time
            const date = new Date();
            date.setHours(hour);
            date.setMinutes(minute);
            
            const formattedTime = date.toLocaleTimeString([], {
                hour: 'numeric',
                minute: '2-digit'
            });
            
            switch (recurrence.type) {
                case 'daily':
                    return `Daily at ${formattedTime}`;
                case 'weekly':
                    return `Every ${recurrence.interval.charAt(0).toUpperCase() + 
                           recurrence.interval.slice(1)} at ${formattedTime}`;
                case 'monthly':
                    return `Monthly on day ${recurrence.interval} at ${formattedTime}`;
                default:
                    return '';
            }
        }

        // Update the createReminderCard function
        function createReminderCard(reminder, container, status) {
            const div = document.createElement('div');
            const isActive = reminder.active;
            
            div.className = `bg-white rounded-lg shadow-sm border ${isActive ? 'border-green-100' : 'border-gray-100'} 
                           p-4 hover:shadow-md transition-shadow relative group 
                           ${isActive ? 'bg-gradient-to-r from-red-50/50 to-white' : 'bg-gray-50/50'} mb-3`;
            
            // Format the reminder time/schedule
            let timeDisplay = '';
            let timeClass = isActive ? 'text-green-600' : 'text-gray-500';
            
            // Get recurrence info
            const recurrenceInfo = reminder.recurrence ? formatRecurrence(reminder.recurrence) : '';
            
            if (recurrenceInfo) {
                timeDisplay = recurrenceInfo;
            } else {
                timeDisplay = `One-time: ${formatTimestamp(reminder.target_time)}`;
            }
            
            div.innerHTML = `
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-grow">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="w-4 h-4 ${isActive ? 'text-green-500' : 'text-gray-400'}" 
                                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="font-medium ${isActive ? 'text-gray-900' : 'text-gray-500'}">${reminder.text}</span>
                            ${isActive ? '<span class="ml-2 px-2 py-0.5 bg-red-100 text-red-600 text-xs rounded-full">Active</span>' : 
                               '<span class="ml-2 px-2 py-0.5 bg-gray-100 text-gray-500 text-xs rounded-full">Past</span>'}
                        </div>
                        <div class="text-sm ${timeClass}">
                            ${timeDisplay}
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            Created: ${formatTimestamp(reminder.created_at)}
                        </div>
                        ${reminder.recurrence && reminder.recurrence.type !== 'none' ? `
                            <div class="text-xs text-blue-500 mt-1">
                                Next occurrence: ${formatTimestamp(reminder.target_time)}
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="deleteReminder('${reminder.created_at}', event)"
                            class="p-2 bg-red-500 rounded-full text-white opacity-0 group-hover:opacity-90 hover:opacity-100 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(div);
        }

        // Add these toast notification functions
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' :
                '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';

            toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 transition-all duration-300 opacity-0 transform translate-x-full`;
            toast.innerHTML = `
                ${icon}
                <span>${message}</span>
            `;

            const container = document.getElementById('toast-container');
            container.appendChild(toast);

            // Trigger animation
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-full');
            }, 10);

            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        async function deleteReminder(created_at, event) {
            // Stop event propagation and prevent default behavior
            event.preventDefault();
            event.stopPropagation();
            
            // Create confirmation dialog
            const confirmDialog = document.createElement('div');
            confirmDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm mx-4 shadow-xl">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Delete Reminder</h3>
                    <p class="text-gray-600 mb-6">Are you sure you want to delete this reminder?</p>
                    <div class="flex justify-end gap-3">
                        <button class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium" onclick="this.closest('.fixed').remove()">
                            Cancel
                        </button>
                        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium confirm-delete">
                            Delete
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(confirmDialog);

            // Handle delete confirmation
            confirmDialog.querySelector('.confirm-delete').addEventListener('click', async () => {
                confirmDialog.remove();
                
                try {
                    const response = await fetch('/signal/api/delete_reminder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sender: '${sender}',
                            created_at: created_at
                        })
                    });

                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // Show success toast
                        showToast('Reminder deleted successfully');
                        
                        // Find and remove the reminder element with animation
                        const reminderElement = event.target.closest('.section-card');
                        if (reminderElement) {
                            const reminderCard = event.target.closest('[class*="bg-white rounded-lg"]');
                            if (reminderCard) {
                                reminderCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                                reminderCard.style.opacity = '0';
                                reminderCard.style.transform = 'scale(0.95)';
                                
                                setTimeout(() => {
                                    reminderCard.remove();
                                    
                                    // Check if there are no more reminders
                                    const remindersGrid = document.getElementById('reminders-grid');
                                    if (remindersGrid && !remindersGrid.children.length) {
                                        remindersGrid.innerHTML = `
                                            <p class="text-gray-500 text-sm text-center py-4 animate-fade-in">
                                                No active reminders
                                            </p>
                                        `;
                                    }
                                }, 300);
                            }
                        }
                    } else {
                        showToast(data.message || 'Failed to delete reminder', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting reminder:', error);
                    showToast('Error deleting reminder. Please try again.', 'error');
                }
            });
        }

        // Initialize sections on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get all section headers and initialize them
            const sections = ['messages', 'images', 'ai-images', 'pdfs', 'reminders'];
            sections.forEach(section => {
                const content = document.getElementById(`${section}-content`);
                const arrow = document.getElementById(`${section}-arrow`);
                
                if (content && arrow) {
                    content.classList.add('hidden');
                    arrow.classList.remove('rotate-180');
                }
            });
        });

        // Update showImageModal to use attachment_key
        async function showImageModal(attachment_key, metadata, type) {
            try {
                const response = await fetch(`/read?key=${attachment_key}`);
                const data = await response.json();
                
                showModal({
                    data: data.value.data || data.value
                }, metadata, type);
            } catch (error) {
                console.error('Error fetching attachment:', error);
            }
        }
    </script>
</body>
</html> 
